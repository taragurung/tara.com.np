---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Button from '../components/Button.astro';
import Hero from '../components/Hero.astro';
import PostPreview from '../components/PostPreview.astro';
import ProjectPreview from '../components/ProjectPreview.astro';
import siteConfig from '../data/site-config';
import { sortItemsByDateDesc } from '../utils/data-utils';

// Get all blog posts and sort them by date (most recent first)
const posts = (await getCollection('blog')).sort(sortItemsByDateDesc);
const featuredPosts = posts.filter(({ data }) => data.isFeatured);
// Get the 4 most recent posts for the latest blog section
const latestPosts = posts.slice(0, 4);

const projects = (await getCollection('projects')).sort(sortItemsByDateDesc);
const featuredProjects = projects.filter(({ data }) => data.isFeatured);

// Helper function to format date safely
function formatDate(dateValue) {
  if (!dateValue) return '';
  
  try {
    // Handle different date formats
    const date = new Date(dateValue);
    
    // Check if date is valid before formatting
    if (isNaN(date.getTime())) {
      return '';
    }
    
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  } catch (error) {
    return '';
  }
}
---

<BaseLayout description={siteConfig.description} image={siteConfig.image}>
    <Hero />
    {
        featuredProjects?.length > 0 && (
            <div class="mb-16 sm:mb-24">
                <h2 class="mb-12 text-xl font-serif italic sm:mb-16 sm:text-2xl">Projects</h2>
                {featuredProjects.map((project) => (
                    <ProjectPreview project={project} class="mb-10 sm:mb-12" headingLevel="h3" />
                ))}
                <div class="mt-12 sm:mt-16">
                    <Button href="/projects">View All Projects</Button>
                </div>
            </div>
        )
    }
    {
        featuredPosts?.length > 0 && (
            <div class="mb-16 sm:mb-24">
                <h2 class="mb-12 text-xl font-serif italic sm:mb-16 sm:text-2xl">Writing</h2>
                {featuredPosts.map((post) => (
                    <PostPreview post={post} class="mb-10 sm:mb-12" headingLevel="h3" />
                ))}
                <div class="mt-12 sm:mt-16">
                    <Button href="/blog">View All Posts</Button>
                </div>
            </div>
        )
    }
    
    <!-- Latest Blog Posts Section -->
    <div class="mb-16 sm:mb-24">
        <h2 class="mb-12 text-xl font-serif italic sm:mb-16 sm:text-2xl">Latest from the Blog</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {latestPosts.map((post) => (
                <div class="bg-secondary dark:bg-secondary rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300">
                    {post.data.image && (
                        <a href={`/blog/${post.slug}`}>
                            <img 
                                src={post.data.image} 
                                alt={post.data.title} 
                                class="w-full h-48 object-cover"
                            />
                        </a>
                    )}
                    <div class="p-4">
                        <p class="text-sm text-muted-foreground mb-2">
                            {/* Check what date field is available */}
                            {post.data.pubDate && formatDate(post.data.pubDate)}
                            {!post.data.pubDate && post.data.date && formatDate(post.data.date)}
                            {post.data.author && ` â€¢ ${post.data.author}`}
                        </p>
                        <a href={`/blog/${post.slug}`} class="hover:underline">
                            <h3 class="text-xl font-semibold mb-2">{post.data.title}</h3>
                        </a>
                        {post.data.description && (
                            <p class="text-muted-foreground mb-4 line-clamp-2">{post.data.description}</p>
                        )}
                        <a 
                            href={`/blog/${post.slug}`} 
                            class="inline-block text-primary hover:text-primary-foreground font-medium"
                        >
                            Read more
                        </a>
                    </div>
                </div>
            ))}
        </div>
        <div class="mt-12 sm:mt-16">
            <Button href="/blog">View All Posts</Button>
        </div>
    </div>
</BaseLayout>
